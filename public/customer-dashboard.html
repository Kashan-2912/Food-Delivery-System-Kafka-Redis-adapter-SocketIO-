<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard - FoodExpress</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .dashboard-container {
      min-height: 100vh;
      background: #f5f5f5;
    }

    .hero-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 60px 20px;
      text-align: center;
    }

    .hero-section h1 {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .hero-section p {
      font-size: 1.3em;
      opacity: 0.9;
    }

    .restaurant-card {
      cursor: pointer;
      transition: all 0.3s;
    }

    .restaurant-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }

    .restaurant-image {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px 10px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4em;
    }

    .restaurant-info {
      padding: 20px;
    }

    .restaurant-name {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .restaurant-meta {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 30px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: #667eea;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .order-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
    }

    .modal.show {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .cart-summary {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #667eea;
      color: white;
      padding: 20px 30px;
      border-radius: 50px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1em;
      animation: bounce 0.5s;
    }

    .cart-summary:hover {
      transform: scale(1.05);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <a href="/customer-dashboard.html" class="navbar-brand">üçï FoodExpress</a>
    <ul class="navbar-menu">
      <li><a href="#" id="welcomeText">Welcome!</a></li>
      <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
  </nav>

  <div class="dashboard-container">
    <!-- Hero Section -->
    <div class="hero-section">
      <h1>üçΩÔ∏è Order Your Favorite Food</h1>
      <p>Choose from the best restaurants in town</p>
    </div>

    <div class="container" style="margin-top: 40px;">
      <!-- Tabs -->
      <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('restaurants', event)">üè™ Browse Restaurants</button>
        <button class="tab-btn" onclick="switchTab('orders', event)">üì¶ My Orders</button>
      </div>

      <div id="alert" class="alert hidden"></div>

      <!-- Restaurants Tab -->
      <div id="restaurantsTab" class="tab-content active">
        <h2 style="margin-bottom: 30px;">Available Restaurants</h2>
        <div id="restaurantsList" class="grid grid-3">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading restaurants...</p>
          </div>
        </div>
      </div>

      <!-- Orders Tab -->
      <div id="ordersTab" class="tab-content">
        <h2 style="margin-bottom: 30px;">My Orders</h2>
        <div id="ordersList">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading your orders...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Restaurant Menu Modal -->
  <div id="menuModal" class="modal">
    <div class="modal-content">
      <div class="flex-between" style="margin-bottom: 30px;">
        <h2 id="modalRestaurantName">Restaurant Menu</h2>
        <button onclick="closeModal()" class="btn btn-secondary">Close</button>
      </div>
      <div id="menuItems"></div>
      <div id="cartItems" style="margin-top: 30px;"></div>
      <button id="checkoutBtn" onclick="checkout()" class="btn btn-primary" style="width: 100%; margin-top: 20px; display: none;">
        Proceed to Checkout
      </button>
    </div>
  </div>

  <!-- Cart Summary -->
  <div id="cartSummary" class="cart-summary" onclick="showCart()" style="display: none;">
    üõí <span id="cartCount">0</span> items - <span id="cartTotal">$0.00</span>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    // Check authentication
    if (!requireAuth()) {
      window.location.href = '/login.html';
    }

    const user = getUser();
    if (user.role !== 'customer') {
      window.location.href = '/restaurant-dashboard.html';
    }

    document.getElementById('welcomeText').textContent = `Welcome, ${user.name}!`;

    let cart = [];
    let currentRestaurant = null;

    // Switch tabs
    function switchTab(tab, event) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      if (event && event.target) {
        event.target.classList.add('active');
      } else {
        // Fallback: find and activate the button by tab name
        document.querySelectorAll('.tab-btn').forEach(btn => {
          if (btn.textContent.toLowerCase().includes(tab)) {
            btn.classList.add('active');
          }
        });
      }
      
      document.getElementById(tab + 'Tab').classList.add('active');

      if (tab === 'restaurants') {
        loadRestaurants();
      } else if (tab === 'orders') {
        loadOrders();
      }
    }

    // Load restaurants
    async function loadRestaurants() {
      try {
        const data = await apiCall('/restaurants');
        
        const container = document.getElementById('restaurantsList');
        
        if (data.data.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666;">No restaurants available yet.</p>';
          return;
        }

        container.innerHTML = data.data.map(restaurant => `
          <div class="card restaurant-card" onclick="openRestaurant('${restaurant._id}', '${restaurant.name}', '${restaurant.tenantId}')">
            <div class="restaurant-image">üçΩÔ∏è</div>
            <div class="restaurant-info">
              <div class="restaurant-name">${restaurant.name}</div>
              <p style="color: #666; margin: 10px 0;">${restaurant.description || 'Delicious food awaits!'}</p>
              <div class="restaurant-meta">
                <span>‚≠ê ${restaurant.rating.toFixed(1)}</span>
                <span>üïê ${restaurant.estimatedDeliveryTime || 30} min</span>
                <span>üí∞ $${restaurant.minimumOrder || 0} min</span>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading restaurants:', error);
        showAlert('Error loading restaurants', 'error');
      }
    }

    // Open restaurant menu
    async function openRestaurant(id, name, tenantId) {
      try {
        currentRestaurant = { id, name, tenantId };
        cart = [];
        updateCartUI();

        const data = await apiCall(`/restaurants/${id}/menu`);
        
        document.getElementById('modalRestaurantName').textContent = name;
        const menuContainer = document.getElementById('menuItems');
        
        if (data.data.length === 0) {
          menuContainer.innerHTML = '<p style="text-align: center; color: #666;">No menu items available.</p>';
        } else {
          menuContainer.innerHTML = data.data.map(item => `
            <div class="menu-item">
              <div>
                <h4>${item.name}</h4>
                <p style="color: #666; margin: 5px 0;">${item.description || ''}</p>
                <p style="font-weight: bold; color: #667eea; margin-top: 10px;">${formatCurrency(item.price)}</p>
              </div>
              <button onclick='addToCart(${JSON.stringify(item).replace(/'/g, "&apos;")})' class="btn btn-primary">
                Add +
              </button>
            </div>
          `).join('');
        }

        document.getElementById('menuModal').classList.add('show');
      } catch (error) {
        console.error('Error loading menu:', error);
        showAlert('Error loading menu', 'error');
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('menuModal').classList.remove('show');
      cart = [];
      updateCartUI();
    }

    // Add to cart
    function addToCart(item) {
      const existingItem = cart.find(i => i.menuItemId === item._id);
      if (existingItem) {
        existingItem.quantity++;
      } else {
        cart.push({
          menuItemId: item._id,
          name: item.name,
          price: item.price,
          quantity: 1
        });
      }
      updateCartUI();
    }

    // Update cart UI
    function updateCartUI() {
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);

      document.getElementById('cartCount').textContent = itemCount;
      document.getElementById('cartTotal').textContent = formatCurrency(total);
      document.getElementById('cartSummary').style.display = itemCount > 0 ? 'block' : 'none';
      document.getElementById('checkoutBtn').style.display = itemCount > 0 ? 'block' : 'none';

      // Update cart items display
      const cartContainer = document.getElementById('cartItems');
      if (itemCount > 0) {
        cartContainer.innerHTML = `
          <h3 style="margin-bottom: 15px;">Your Cart</h3>
          ${cart.map(item => `
            <div class="flex-between" style="padding: 10px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
              <div>
                <strong>${item.name}</strong>
                <br>
                <span style="color: #666;">Qty: ${item.quantity} √ó ${formatCurrency(item.price)}</span>
              </div>
              <div>
                <strong>${formatCurrency(item.price * item.quantity)}</strong>
              </div>
            </div>
          `).join('')}
          <div class="flex-between" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
            <strong>Total:</strong>
            <strong style="font-size: 1.3em; color: #667eea;">${formatCurrency(total)}</strong>
          </div>
        `;
      } else {
        cartContainer.innerHTML = '';
      }
    }

    // Checkout
    async function checkout() {
      if (cart.length === 0) {
        showAlert('Your cart is empty', 'warning');
        return;
      }

      const address = prompt('Enter your delivery address:');
      if (!address) return;

      try {
        const orderData = {
          restaurantId: currentRestaurant.id,
          items: cart,
          deliveryAddress: {
            street: address,
            city: 'Boston',
            state: 'MA',
            zipCode: '02101'
          },
          paymentMethod: 'card'
        };

        const data = await apiCall('/orders', {
          method: 'POST',
          body: JSON.stringify(orderData)
        });

        if (data.success) {
          showAlert('Order placed successfully!', 'success');
          closeModal();
          switchTab('orders', null);
        }
      } catch (error) {
        console.error('Checkout error:', error);
        showAlert(error.message || 'Error placing order', 'error');
      }
    }

    // Show cart
    function showCart() {
      if (currentRestaurant) {
        document.getElementById('menuModal').classList.add('show');
      }
    }

    // Load orders
    async function loadOrders() {
      try {
        const data = await apiCall('/orders');
        
        const container = document.getElementById('ordersList');
        
        if (data.data.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #666;">You haven\'t placed any orders yet.</p>';
          return;
        }

        container.innerHTML = data.data.map(order => `
          <div class="order-item">
            <div class="order-header">
              <div>
                <h3>${order.orderNumber}</h3>
                <p style="color: #666;">${formatDate(order.createdAt)}</p>
              </div>
              <span class="badge ${getStatusBadgeClass(order.status)}">
                ${order.status.replace('_', ' ')}
              </span>
            </div>
            <div>
              <p><strong>Restaurant:</strong> ${order.restaurantId.name}</p>
              <p><strong>Items:</strong> ${order.items.length} items</p>
              <p style="font-size: 1.2em; font-weight: bold; margin-top: 10px;">
                Total: ${formatCurrency(order.total)}
              </p>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading orders:', error);
        showAlert('Error loading orders', 'error');
      }
    }

    // Initial load
    loadRestaurants();
  </script>
</body>
</html>

